<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DP-Next - Work Package 4: Intervention Development</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(site_libs/quarto-contrib/quarto-project/steno-aarhus/sdca-theme/images/banner-faded.png);
background-size: cover;
      }
</style>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">DP-Next</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-wp1" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">WP1</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-wp1">    
        <li>
    <a class="dropdown-item" href="./wp1/index.html">
 <span class="dropdown-text">Abstract</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./wp1/introduction.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./wp1/strategy.html">
 <span class="dropdown-text">Strategy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./wp1/roadmap.html">
 <span class="dropdown-text">Roadmap</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./wp1/application.html">
 <span class="dropdown-text">Applications</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./wp2.html"> 
<span class="menu-text">WP2</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./wp3.html"> 
<span class="menu-text">WP3</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./wp4.html" aria-current="page"> 
<span class="menu-text">WP4</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./whoweare.html"> 
<span class="menu-text">Who We Are</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <a href="https://github.com/steno-aarhus/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/StenoAarhusRes" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Work Package 4: Intervention Development</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#psda-process-components" id="toc-psda-process-components" class="nav-link active" data-scroll-target="#psda-process-components">PSDA process components</a>
  <ul class="collapse">
  <li><a href="#stage-1-preparation-phase" id="toc-stage-1-preparation-phase" class="nav-link" data-scroll-target="#stage-1-preparation-phase">Stage 1: Preparation phase</a></li>
  <li><a href="#stage-2-group-model-building-and-systems-mapping" id="toc-stage-2-group-model-building-and-systems-mapping" class="nav-link" data-scroll-target="#stage-2-group-model-building-and-systems-mapping">Stage 2: Group Model Building and Systems Mapping</a></li>
  <li><a href="#stage-3-implementation-of-actions-support-and-monitoring" id="toc-stage-3-implementation-of-actions-support-and-monitoring" class="nav-link" data-scroll-target="#stage-3-implementation-of-actions-support-and-monitoring">Stage 3: Implementation of actions, support and monitoring</a></li>
  </ul></li>
  <li><a href="#example-of-psda-in-a-high-risk-target-group." id="toc-example-of-psda-in-a-high-risk-target-group." class="nav-link" data-scroll-target="#example-of-psda-in-a-high-risk-target-group.">Example of PSDA in a high-risk target group.</a>
  <ul class="collapse">
  <li><a href="#stage-1" id="toc-stage-1" class="nav-link" data-scroll-target="#stage-1">Stage 1:</a></li>
  <li><a href="#stage-2" id="toc-stage-2" class="nav-link" data-scroll-target="#stage-2">Stage 2:</a></li>
  <li><a href="#stage-3" id="toc-stage-3" class="nav-link" data-scroll-target="#stage-3">Stage 3:</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/steno-aarhus/dp-next/edit/main/wp4.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/steno-aarhus/dp-next/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/steno-aarhus/dp-next/blob/main/wp4.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>The vision for WP4 is to develop and feasibility test a new set of interventions based on a participatory system dynamics approach (PSDA) to prevent diabetes in selected high-risk target groups defined in WP2. This approach was chosen over the highly protocolised and expert based approaches applied to diabetes prevention so far with disappointing long-term impact. The interventions will be developed in co-creation with citizens, families, local organisations, councils and health care providers to achieve sustainable diabetes prevention. Implementation will be across selected regions, municipalities and local communities in Denmark, Greenland and the Faroe Islands in order to create local and sustainable solutions to prevent type 2 diabetes.</p>
<p>The PSDA process combines current evidence on prevention and health promotion, best practice and local insights to achieve new knowledge and create feasible and sustainable solutions/interventions for a complex health challenge such as diabetes prevention29,30. This approach implies that a variety of engagement and solutions may occur at both the interpersonal and organisational levels. Hence, addressing health in a systems approach, rather than at an individual level only, is novel in the sense that it acknowledges that changes in one aspect of the system can have ripple effects throughout the entire system31,32. We hypothesise that developing co-created intervention(s) inspired by psychosocial theories such as motivation, health literacy, social support and social networks and based in the local community setting/family setting, will result in sustainable improvements in behaviour (diet, physical activity, sleep) and wellbeing and thereby prevent development of diabetes in people at high risk (WP2).</p>
<p>Several researchers at SDCA, SDCC and SDCS have substantial experience with PSDA in different settings and target groups in Denmark. Employees from all participating SDCs will receive training in how to apply PSDA to solve complex health challenges regarding diabetes prevention. The target group for the training is regional consultants and employees from the selected local communities (e.g.&nbsp;local communities in a municipality) taking part in the development phase.</p>
<section id="psda-process-components" class="level2">
<h2 class="anchored" data-anchor-id="psda-process-components">PSDA process components</h2>
<section id="stage-1-preparation-phase" class="level3">
<h3 class="anchored" data-anchor-id="stage-1-preparation-phase">Stage 1: Preparation phase</h3>
<p>Review of existing evidence and practice regarding diabetes prevention for the specific target group(s) from WP2 and Selection of Regions, municipalities and local communities and identification of key stakeholders.</p>
</section>
<section id="stage-2-group-model-building-and-systems-mapping" class="level3">
<h3 class="anchored" data-anchor-id="stage-2-group-model-building-and-systems-mapping">Stage 2: Group Model Building and Systems Mapping</h3>
<p>Recruitment of key leaders and local stakeholders: A coordinator from participating SDC/regions and municipalities will together with the research team identify and recruit 12-15 key leaders (e.g.&nbsp;local politicians, department heads, municipality leaders) and local stakeholders (e.g.&nbsp;health care providers, local sport club representatives, religious leaders, NGOs within health and social care etc.). Key leaders and local stakeholders will be selected based on authority and capacity to initiate actions that are likely to prevent diabetes across sectors and organisations.<br>
Group Model Building and systems mapping: During this stage, three workshops (WS1, WS2, WS3) will be held in each participating community. WS1 and WS2 will engage the key leaders and stakeholders. Local health profiles (based on data from the target groups found in WP2) will be presented to provide the first critical engagement step. The key leaders and stakeholders will map the system by building a causal loop diagram to understand how the perceived local system affects the diabetes development in their community. In WS3, all community members willing to engage in driving the change in the local system will be invited to identify priority areas for actions based on the causal loop diagram from WS1 and WS2.</p>
</section>
<section id="stage-3-implementation-of-actions-support-and-monitoring" class="level3">
<h3 class="anchored" data-anchor-id="stage-3-implementation-of-actions-support-and-monitoring">Stage 3: Implementation of actions, support and monitoring</h3>
<p>Actions and support: the output of WS3 is the formation of working groups across the sectors that will focus on implementing chosen actions. The working groups will be supported and supervised by a backbone office consisting of the regional and municipal coordinator(s) and the research team. A follow-up workshop (WS4) will be held with the key stakeholders six months after completion of WS3 to review the consolidated priority actions. To increase and maintain motivation and actions across region, municipality and community, subsequent follow-up meetings will be held with the working groups when needed during the follow-up period after WS3. Monitoring: At an annual meeting across region, municipality and community, health data will be presented to action groups, key leaders and stakeholders, to sustain and promote engagement. Evaluation</p>
<p>We will assess if the intervention and study procedures (WP4) are feasible by combining qualitative and quantitative data, focusing on practicality, acceptability, fidelity, and limited-effectiveness testing. Combined, these elements will give an essential understanding of what is required to upscale DP-Next to large-scale testing. The evaluation will be guided by recent frameworks33,34 and will be constructed to allow for systematic documentation of processes and tentative outcomes. A final program theory on “what works for whom under what circumstances” based on the participatory systems dynamic approach will be made, including recommendations for large-scale testing. In addition to systems measurements, individual measurements will be collected in order to evaluate the specific actions (specific intervention components), e.g.&nbsp;changes in HbA1c, physical activity, diet patterns, sleep, general well-being, health literacy and social support.</p>
<div id="fig-PSDA-steps-WP3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-PSDA-steps-WP3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/Platforms3b.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-PSDA-steps-WP3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Steps in the Participatory System Dynamics Approach.
</figcaption>
</figure>
</div>
</section>
</section>
<section id="example-of-psda-in-a-high-risk-target-group." class="level2">
<h2 class="anchored" data-anchor-id="example-of-psda-in-a-high-risk-target-group.">Example of PSDA in a high-risk target group.</h2>
<p>To concretize the PSDA, the process is described in detail for a known high-risk group: ‘Women with a history of gestational diabetes (GDM)’. The same approach will be followed for other identified high-risk groups, ensuring that each group’s unique risks and needs are thoroughly assessed and addressed with the same rigour and systematic methodology.</p>
<section id="stage-1" class="level3">
<h3 class="anchored" data-anchor-id="stage-1">Stage 1:</h3>
<p>More than 3,500 (6%) pregnant women are annually diagnosed with GDM in Denmark and the number has increased 3-fold in the last decades35. Women with GDM have an increased risk of long-term adverse health outcomes, including impaired glucose tolerance, T2D, and cardiovascular disease. GDM leaves the mother with an 8-10-fold higher risk of T2D, highest within 3-6 years after the GDM pregnancy36,37. A recent Danish study found that almost 21% of women offered a clinical follow-up program, aiming at supporting women with GDM, had developed pre-diabetes, T2D or T1D one year postpartum38. Studies have shown that T2D can be prevented or at least postponed by weight loss, physical activity, and diet3,4,39. A low intensity family based intervention delivered in the first year after delivery in a Danish setting targeting women with prior GDM and their families showed improvements in a number of cardiometabolic risk factors, and was found acceptable and feasible for families and HCP (unpublished data for the FACE-IT study40). Although regular participation in follow-up screening at GP (recommended guidelines) has been shown to increase the likelihood of early detection of prediabetes/T2D, participation is low38. Qualitative research has shown the use of electronic reminders of follow-up screening after GDM to be well received by women, although the interaction with their GP played a significant role41 and that there is remaining need for support from healthcare providers for healthy lifestyle modifications adapted to their situation42. Thus, the follow-up of women with GDM in general practice is not systematic, and hence, prevention of diabetes is suboptimal.</p>
</section>
<section id="stage-2" class="level3">
<h3 class="anchored" data-anchor-id="stage-2">Stage 2:</h3>
<p>The PSDA-example builds on this improvement potential by optimising the clinical follow-up in general practice using PSDA. Potential participants in the GMB process and system mapping (WS1-3) could potentially be: GP´s, families where the mother has been diagnosed with GDM, midwives, health visitors, obstetricians, endocrinologists, NGO´s and primary care coordinators.</p>
</section>
<section id="stage-3" class="level3">
<h3 class="anchored" data-anchor-id="stage-3">Stage 3:</h3>
<p>Based on the system mapping, working groups will be created and actions will start to be developed aiming to increase participation in the clinical follow-up visits at the GP. Thus it could be suggested that women with previous GDM could have a fasting blood glucose and an HbA1c taken postpartum at the 3-months child examination at the GP in order to follow the current Danish guidelines. In addition the woman will be reminded to have an HbA1c taken yearly also in alignment with the current guidelines. Examples of possible actions/interventions could be: To develop and evaluate risk communication strategies for GP´s to women with prior GDM and their families in order to increase continued participation. To enhance systems supporting the data-infrastructure, e.g.&nbsp;by using reminders41 and platforms to access data (e.g.&nbsp;existing systems like SAMBLIK and alike)</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/steno-aarhus\.github\.io\/dp-next\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>License: CC BY 4.0</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://steno-aarhus.github.io/research/CONTRIBUTING.html">
<p>Contributing guidelines</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://steno-aarhus.github.io/research/CODE_OF_CONDUCT.html">
<p>Code of Conduct</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/steno-aarhus/dp-next/edit/main/wp4.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/steno-aarhus/dp-next/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/steno-aarhus/dp-next/blob/main/wp4.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>